!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.JsDap=e():t.JsDap=e()}(window,function(){return function(t){var e={};function r(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,s){r.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},r.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=4)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){if(t){var e=document.createElement("script");e.setAttribute("type","text/vbscript"),e.innerHTML="\n            Function BinaryToArray(Binary)\n Dim i\n ReDim byteArray(LenB(Binary))\n            For i = 1 To LenB(Binary)\n byteArray(i-1) = AscB(MidB(Binary, i, 1))\n            Next\n BinaryToArray = byteArray\n End Function\n ",document.head.appendChild(e)}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){for(var r=0;r<e.length;r++){var s=e[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,r,s){return r&&t(e.prototype,r),s&&t(e,s),e}}();function n(t,e){for(++e;--e;t=1073741824==(1073741824&(t%=2147483648))?2*t:2*(t-1073741824)+2147483647+1);return t}function a(t,e,r){if(e<0||r<=0)return 0;for(var s,a=e%8,i=t.length-(e>>3)-1,u=t.length+(-(e+r)>>3),o=i-u,c=(t[i]>>a&(1<<(o?8-a:r))-1)+(o&&(s=(e+r)%8)?(t[u++]&(1<<s)-1)<<(o--<<3)-a:0);o;c+=n(t[u++],(o--<<3)-a));return c}function i(t,e,r){var s=a(t,0,8*e),n=Math.pow(2,8*e);return r&&s>=n/2?s-n:s}function u(t,e,r){var s,n,i,u=Math.pow(2,r-1)-1,o=a(t,e+r,1),c=a(t,e,r),h=0,p=2,f=t.length+(-e>>3)-1;do{for(s=t[++f],i=1<<(n=e%8||8);i>>=1;s&i&&(h+=1/p),p*=2);}while(e-=n);return c==1+(u<<1)?h?NaN:o?-1/0:1/0:(1+-2*o)*(c||h?c?Math.pow(2,c-u)*(1+h):Math.pow(2,1-u)*h:0)}e.getBuffer=function(t){for(var e=new Array(t.length),r=0;r<t.length;r++)e[r]=255&t.charCodeAt(r);return e},e.dapUnpacker=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._buf=e,this.dapvar=r,this._pos=0}return s(t,[{key:"getValue",value:function(){var t=this._pos,e=this.dapvar.type.toLowerCase();if("structure"==e||"dataset"==e){var r=[],s=this.dapvar;for(var n in s)s[n].type&&(this.dapvar=s[n],o=this.getValue(),r.push(o));return this.dapvar=s,r}if("grid"==e){for(var a in r=[],s=this.dapvar,this.dapvar=s.array,o=this.getValue(),r.push(o),s.maps)this.dapvar=s.maps[a],o=this.getValue(),r.push(o);return this.dapvar=s,r}if("sequence"==e){var i,u=this._unpack_uint32();for(r=[],s=this.dapvar;2768240640!=u;){for(var n in i=[],s)s[n].type&&(this.dapvar=s[n],o=this.getValue(),i.push(o));r.push(i),u=this._unpack_uint32()}return this.dapvar=s,r}if("Z\0\0\0"==this._buf.slice(t,t+4)){var o;for(u=this._unpack_uint32(),r=[];2768240640!=u;)o=this.getValue(),r.push(o),u=this._unpack_uint32();return r}var c=1;if(this.dapvar.shape.length&&(c=this._unpack_uint32(),"url"!=e&&"string"!=e&&this._unpack_uint32()),"byte"==e)r=this._unpack_bytes(c);else if("url"==e||"string"==e)r=this._unpack_string(c);else{var h;switch(r=[],e){case"float32":h="_unpack_float32";break;case"float64":h="_unpack_float64";break;case"int":h="_unpack_int32";break;case"uint":h="_unpack_uint32";break;case"int16":h="_unpack_int16";break;case"uint16":h="_unpack_uint16";break;case"int32":h="_unpack_int32";break;case"uint32":h="_unpack_uint32"}for(t=0;t<c;t++)r.push(this[h]())}return this.dapvar.shape?function t(e,r){if(!r.length)return e[0];for(var s,n,a,i=[],u=0;u<r[0];u++)a=(n=u*(s=e.length/r[0]))+s,i.push(t(e.slice(n,a),r.slice(1)));return i}(r,this.dapvar.shape):r[0]}},{key:"_unpack_byte",value:function(){var t=this._pos;return this._pos=t+1,i(this._buf.slice(t,t+1),1,!1)}},{key:"_unpack_uint16",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!1)}},{key:"_unpack_uint32",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!1)}},{key:"_unpack_int16",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!0)}},{key:"_unpack_int32",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!0)}},{key:"_unpack_float32",value:function(){var t=this._pos;return this._pos=t+4,u(this._buf.slice(t,t+4),23,8)}},{key:"_unpack_float64",value:function(){var t=this._pos;return this._pos=t+8,u(this._buf.slice(t,t+8),52,11)}},{key:"_unpack_bytes",value:function(t){for(var e=this._pos,r=[],s=0;s<t;s++)r.push(this._unpack_byte());var n=(4-t%4)%4;return this._pos=e+t+n,r}},{key:"_unpack_string",value:function(t){for(var e,r,s,n=[],a=0;a<t;a++){e=this._unpack_uint32(),u=this._pos,r=this._buf.slice(u,u+e),s=(4-e%4)%4,this._pos=u+e+s;for(var i="",u=0;u<e;u++)i+=String.fromCharCode(r[u]);n.push(i)}return n}}]),t}()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var s=e[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,r,s){return r&&t(e.prototype,r),s&&t(e,s),e}}();function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var atomicTypes=["byte","int","uint","int16","uint16","int32","uint32","float32","float64","string","url","alias"],structures=["Sequence","Structure","Dataset"],IDENTIFIER_REGEX="[\\w-/]";function pseudoSafeEval(str){return/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(str.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,""))?eval("("+str+")"):str}Array.prototype.contains=function(t){for(var e=0,r=this[e];e<this.length;r=this[++e])if(t==r)return!0;return!1},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^[\s\n\r\t]+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")};var dapType=function t(e){_classCallCheck(this,t),this.type=e,this.attributes={}},simpleParser=function(){function t(e){_classCallCheck(this,t),this.stream=e}return _createClass(t,[{key:"peek",value:function(t){var e=new RegExp("^"+t,"i"),r=this.stream.match(e);return r?r[0]:""}},{key:"consume",value:function(t){var e=new RegExp("^"+t,"i");this.stream=this.stream.replace(/(?:\r\n|\r|\n)/g,""),this.stream=this.stream.replace(/\s\s+/g," "),this.stream=this.stream.replace(/\\/g,"/");var r=this.stream.match(e);if(console.log("match",r),r)return this.stream=this.stream.substr(r[0].length).ltrim(),r[0];throw new Error("Unable to parse stream: "+this.stream.substr(0,10))}}]),t}(),ddsParser=exports.ddsParser=function(t){function e(t){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.dds=t,r}return _inherits(e,simpleParser),_createClass(e,[{key:"parse",value:function(){var t=new dapType("Dataset");for(this.consume("dataset"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}return this.consume("}"),t.id=t.name=this.consume("[^;]+"),this.consume(";"),function t(e,r){for(var s in e){var n=e[s];n.type&&(n.id=n.name,r&&(n.id=e.id+"."+n.id),t(n,!0))}}(t,!1),t}},{key:"_declaration",value:function(){switch(this.peek(IDENTIFIER_REGEX+"+").toLowerCase()){case"grid":return this._grid();case"structure":return this._structure();case"sequence":return this._sequence();default:return this._base_declaration()}}},{key:"_base_declaration",value:function(){var t=new dapType;for(t.type=this.consume(IDENTIFIER_REGEX+"+"),t.name=this.consume(IDENTIFIER_REGEX+"+"),t.dimensions=[],t.shape=[];!this.peek(";");){this.consume("\\[");var e=this.consume(IDENTIFIER_REGEX+"+");this.peek("=")&&(t.dimensions.push(e),this.consume("="),e=this.consume("\\d+")),t.shape.push(parseInt(e)),this.consume("\\]")}return this.consume(";"),t}},{key:"_grid",value:function(){var t=new dapType("Grid");for(this.consume("grid"),this.consume("{"),this.consume("array"),this.consume(":"),t.array=this._base_declaration(),this.consume("maps"),this.consume(":"),t.maps={};!this.peek("}");){var e=this._base_declaration();t.maps[e.name]=e}return this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),this.consume(";"),t}},{key:"_sequence",value:function(){var t=new dapType("Sequence");for(this.consume("sequence"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}return this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),this.consume(";"),t}},{key:"_structure",value:function(){var t=new dapType("Structure");for(this.consume("structure"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}for(this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),t.dimensions=[],t.shape=[];!this.peek(";");){this.consume("\\[");var r=this.consume(IDENTIFIER_REGEX+"+");this.peek("=")&&(t.dimensions.push(r),this.consume("="),r=this.consume("\\d+")),t.shape.push(parseInt(r)),this.consume("\\]")}return this.consume(";"),t}}]),e}(),dasParser=exports.dasParser=function(t){function e(t,r){_classCallCheck(this,e);var s=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return s.das=t,s.dataset=r,s}return _inherits(e,simpleParser),_createClass(e,[{key:"parse",value:function(){for(this._target=this.dataset,this.consume("attributes"),this.consume("{");!this.peek("}");)this._attr_container();return this.consume("}"),this.dataset}},{key:"_attr_container",value:function(){if(atomicTypes.contains(this.peek(IDENTIFIER_REGEX+"+").toLowerCase())){if(this._attribute(this._target.attributes),"Grid"==this._target.type)for(var t in this._target.maps)if(this.dataset[t]){var e=this._target.maps[e];for(var r in e.attributes)this.dataset[e].attributes[r]=e.attributes[r]}}else this._container()}},{key:"_container",value:function(){var t=this.consume("[\\w-_\\./]+");if(this.consume("{"),t.indexOf(".")>-1){for(var e=t.split("."),r=this._target,s=0;s<e.length;s++)this._target=this._target[e[s]];for(;!this.peek("}");)this._attr_container();this.consume("}"),this._target=r}else if(structures.contains(this._target.type)&&this._target[t]){var n=this._target;for(this._target=n[t];!this.peek("}");)this._attr_container();this.consume("}"),this._target=n}else this._target.attributes[t]=this._metadata(),this.consume("}")}},{key:"_metadata",value:function(){for(var t={};!this.peek("}");)if(atomicTypes.contains(this.peek(IDENTIFIER_REGEX+"+").toLowerCase()))this._attribute(t);else{var e=this.consume(IDENTIFIER_REGEX+"+");this.consume("{"),t[e]=this._metadata(),this.consume("}")}return t}},{key:"_attribute",value:function(t){for(var e=this.consume(IDENTIFIER_REGEX+"+"),r=this.consume(IDENTIFIER_REGEX+"+"),s=[];!this.peek(";");){var n=this.consume('".*?[^\\\\]"|[^;,]+');if("string"==e.toLowerCase()||"url"==e.toLowerCase())n=pseudoSafeEval(n);else if("alias"==e.toLowerCase()){var a=void 0,i=void 0;n.match(/^\\./)?(i=n.substring(1).split("."),a=this.dataset):(i=n.split("."),a=this._target);for(var u=0;u<i.length;u++){var o=i[u];n=a=a[o]?a[o]:a.array.name==o?a.array:a.maps[o]?a.maps[o]:a.attributes[o]}}else n="nan"==n.toLowerCase()?NaN:pseudoSafeEval(n);s.push(n),this.peek(",")&&this.consume(",")}this.consume(";"),1==s.length&&(s=s[0]),t[r]=s}}]),e}()},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){for(var r=0;r<e.length;r++){var s=e[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,r,s){return r&&t(e.prototype,r),s&&t(e,s),e}}(),n=r(2),a=r(1),i=function(t){return t&&t.__esModule?t:{default:t}}(r(0)),u=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.IE_HACK=e,(0,i.default)(this.IE_HACK)}return s(t,[{key:"proxyUrl",value:function(t,e,r,s){var n=void 0;if(window.XMLHttpRequest?n=new XMLHttpRequest:window.ActiveXObject&&(n=new window.ActiveXObject("Microsoft.XMLHTTP")),n.open("GET",t,!0),n.overrideMimeType?n.overrideMimeType("text/plain; charset=x-user-defined"):n.setRequestHeader("Accept-Charset","x-user-defined"),s)for(var i in s)n.setRequestHeader(i,s[i]);n.onreadystatechange=function(){4==n.readyState&&(r?this.IE_HACK?e(BinaryToArray(n.responseBody).toArray()):e((0,a.getBuffer)(n.responseText)):e(n.responseText))},n.send("")}},{key:"_applydata",value:function(t,e){var r=0;for(var s in e)e[s].type&&(e[s].data=t[r++],"Structure"==e[s].type&&this._applydata(e[s].data,e[s]))}},{key:"loadData",value:function(t,e,r){var s=this;this.proxyUrl(t,function(t){for(var r="";!r.match(/\nData:\n$/);){var i=t.splice(0,1);if(0===i.length)throw new Error("Error reading data, are you sur this is a .dods request ?");r+=String.fromCharCode(i)}r=r.substr(0,r.length-7);var u=new n.ddsParser(r).parse(),o=new a.dapUnpacker(t,u).getValue();s._applydata(o,u),e(u)},!0,r)}},{key:"loadDataset",value:function(t,e,r){var s=this;this.proxyUrl(t+".dds",function(a){var i=new n.ddsParser(a).parse();s.proxyUrl(t+".das",function(t){i=new n.dasParser(t,i).parse(),e(i)},!1,r)},!1,r)}}]),t}();e.default=u},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){return t&&t.__esModule?t:{default:t}}(r(3));e.default=s.default}]).default});
//# sourceMappingURL=jsdap.js.map