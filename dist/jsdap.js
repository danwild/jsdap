!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.jsdap=e():t.jsdap=e()}(window,function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},r.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=3)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){t&&document.write('<script type="text/vbscript">\n        Function BinaryToArray(Binary)\n            Dim i\n            ReDim byteArray(LenB(Binary))\n            For i = 1 To LenB(Binary)\n                byteArray(i-1) = AscB(MidB(Binary, i, 1))\n            Next\n            BinaryToArray = byteArray\n        End Function\n    <\/script>')}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();function s(t,e){for(++e;--e;t=1073741824==(1073741824&(t%=2147483648))?2*t:2*(t-1073741824)+2147483647+1);return t}function i(t,e,r){if(e<0||r<=0)return 0;for(var n,i=e%8,a=t.length-(e>>3)-1,o=t.length+(-(e+r)>>3),u=a-o,c=(t[a]>>i&(1<<(u?8-i:r))-1)+(u&&(n=(e+r)%8)?(t[o++]&(1<<n)-1)<<(u--<<3)-i:0);u;c+=s(t[o++],(u--<<3)-i));return 0}function a(t,e,r){var n=i(t,0,8*e),s=Math.pow(2,8*e);return r&&n>=s/2?n-s:n}function o(t,e,r){var n=t,s=Math.pow(2,r-1)-1,a=i(n,e+r,1),o=i(n,e,r),u=0,c=2,h=n.length+(-e>>3)-1,p=void 0,l=void 0,f=void 0;do{for(p=n[++h],f=1<<(l=e%8||8);f>>=1;p&f&&(u+=1/c),c*=2);}while(e-=l);return o==1+(s<<1)?u?NaN:a?-1/0:1/0:(1+-2*a)*(o||u?o?Math.pow(2,o-s)*(1+u):Math.pow(2,1-s)*u:0)}e.getBuffer=function(t){for(var e=new Array(t.length),r=0;r<t.length;r++)e[r]=255&t.charCodeAt(r);return e},e.dapUnpacker=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._buf=e,this.daplet=r,this._pos=0}return n(t,[{key:"getValue",value:function(){var t=this._pos,e=this.daplet.type.toLowerCase();if("structure"==e||"dataset"==e){var r=[],n=void 0,s=this.daplet;for(var i in s)s[i].type&&(this.daplet=s[i],n=this.getValue(),r.push(n));return this.daplet=s,r}if("grid"==e){var a=[],o=void 0,u=this.daplet;for(var c in this.daplet=u.array,o=this.getValue(),a.push(o),u.maps)this.daplet=u.maps[c],o=this.getValue(),a.push(o);return this.daplet=u,a}if("sequence"==e){for(var h=this._unpack_uint32(),p=[],l=void 0,f=void 0,_=this.daplet;2768240640!=h;){for(var d in l=[],_)_[d].type&&(this.daplet=_[d],f=this.getValue(),l.push(f));p.push(l),h=this._unpack_uint32()}return this.daplet=_,p}if("Z\0\0\0"==this._buf.slice(t,t+4)){for(var v=this._unpack_uint32(),y=[],m=void 0;2768240640!=v;)m=this.getValue(),y.push(m),v=this._unpack_uint32();return y}var b=1;this.daplet.shape.length&&(b=this._unpack_uint32(),"url"!=e&&"string"!=e&&this._unpack_uint32());var k=void 0;if("byte"==e)k=this._unpack_bytes(b);else if("url"==e||"string"==e)k=this._unpack_string(b);else{k=[];var g=void 0;switch(e){case"float32":g="_unpack_float32";break;case"float64":g="_unpack_float64";break;case"int":g="_unpack_int32";break;case"uint":g="_unpack_uint32";break;case"int16":g="_unpack_int16";break;case"uint16":g="_unpack_uint16";break;case"int32":g="_unpack_int32";break;case"uint32":g="_unpack_uint32"}for(var E=0;E<b;E++)k.push(this[g]())}return this.daplet.shape?function t(e,r){if(!r.length)return e[0];for(var n=[],s=void 0,i=void 0,a=void 0,o=0;o<r[0];o++)a=(i=o*(s=e.length/r[0]))+s,n.push(t(e.slice(i,a),r.slice(1)));return n}(k,this.daplet.shape):k[0]}},{key:"_unpack_byte",value:function(){var t=this._pos;return this._pos=t+1,a(this._buf.slice(t,t+1),1,!1)}},{key:"_unpack_uint16",value:function(){var t=this._pos;return this._pos=t+4,a(this._buf.slice(t,t+4),4,!1)}},{key:"_unpack_uint32",value:function(){var t=this._pos;return this._pos=t+4,a(this._buf.slice(t,t+4),4,!1)}},{key:"_unpack_int16",value:function(){var t=this._pos;return this._pos=t+4,a(this._buf.slice(t,t+4),4,!0)}},{key:"_unpack_int32",value:function(){var t=this._pos;return this._pos=t+4,a(this._buf.slice(t,t+4),4,!0)}},{key:"_unpack_float32",value:function(){var t=this._pos;return this._pos=t+4,o(this._buf.slice(t,t+4),23,8)}},{key:"_unpack_float64",value:function(){var t=this._pos;return this._pos=t+8,o(this._buf.slice(t,t+8),52,11)}},{key:"_unpack_bytes",value:function(t){for(var e=this._pos,r=[],n=0;n<t;n++)r.push(this._unpack_byte());var s=(4-t%4)%4;return this._pos=e+t+s,r}},{key:"_unpack_string",value:function(t){for(var e=[],r=void 0,n=void 0,s=void 0,i=0;i<t;i++){r=this._unpack_uint32(),n=this._pos,s=this._buf.slice(n,n+r);var a=(4-r%4)%4;this._pos=n+r+a;for(var o="",u=0;u<r;u++)o+=String.fromCharCode(s[u]);e.push(o)}return e}}]),t}()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var atomicTypes=["byte","int","uint","int16","uint16","int32","uint32","float32","float64","string","url","alias"],structures=["Sequence","Structure","Dataset"],IDENTIFIER_REGEX="[\\w-/]";function pseudoSafeEval(str){return/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(str.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,""))?eval("("+str+")"):str}Array.prototype.contains=function(t){for(var e=0,r=(void 0)[e];e<(void 0).length;r=(void 0)[++e])if(t==r)return!0;return!1},String.prototype.trim=function(){return(void 0).replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return(void 0).replace(/^[\s\n\r\t]+/,"")},String.prototype.rtrim=function(){return(void 0).replace(/\s+$/,"")};var dapType=function t(e){_classCallCheck(this,t),this.type=e,this.attributes={}},simpleParser=function(){function t(e){_classCallCheck(this,t),this.stream=e}return _createClass(t,[{key:"peek",value:function(t){var e=new RegExp("^"+t,"i"),r=this.stream.match(e);return r?r[0]:""}},{key:"consume",value:function(t){var e=new RegExp("^"+t,"i"),r=this.stream.match(e);if(r)return this.stream=this.stream.substr(r[0].length).ltrim(),r[0];throw new Error("Unable to parse stream: "+this.stream.substr(0,10))}}]),t}(),ddsParser=exports.ddsParser=function(t){function e(t){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.dds=t,r}return _inherits(e,simpleParser),_createClass(e,[{key:"parse",value:function(){var t=new dapType("Dataset");for(this.consume("dataset"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}return this.consume("}"),t.id=t.name=this.consume("[^;]+"),this.consume(";"),function t(e,r){for(var n in e){var s=e[n];s.type&&(s.id=s.name,r&&(s.id=e.id+"."+s.id),t(s,!0))}}(t,!1),t}},{key:"_declaration",value:function(){switch(this.peek(IDENTIFIER_REGEX+"+").toLowerCase()){case"grid":return this._grid();case"structure":return this._structure();case"sequence":return this._sequence();default:return this._base_declaration()}}},{key:"_base_declaration",value:function(){var t=new dapType;for(t.type=this.consume(IDENTIFIER_REGEX+"+"),t.name=this.consume(IDENTIFIER_REGEX+"+"),t.dimensions=[],t.shape=[];!this.peek(";");){this.consume("\\[");var e=this.consume(IDENTIFIER_REGEX+"+");if(this.peek("=")){t.dimensions.push(r),this.consume("=");var r=this.consume("\\d+")}t.shape.push(parseInt(e)),this.consume("\\]")}return this.consume(";"),t}},{key:"_grid",value:function(){var t=new dapType("Grid");for(this.consume("grid"),this.consume("{"),this.consume("array"),this.consume(":"),t.array=this._base_declaration(),this.consume("maps"),this.consume(":"),t.maps={};!this.peek("}");){var e=this._base_declaration();t.maps[e.name]=e}return this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),this.consume(";"),t}},{key:"_sequence",value:function(){var t=new dapType("Sequence");for(this.consume("sequence"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}return this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),this.consume(";"),t}},{key:"_structure",value:function(){var t=new dapType("Structure");for(this.consume("structure"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}for(this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),t.dimensions=[],t.shape=[];!this.peek(";");){this.consume("\\[");var r=this.consume(IDENTIFIER_REGEX+"+");this.peek("=")&&(t.dimensions.push(r),this.consume("="),r=this.consume("\\d+")),t.shape.push(parseInt(r)),this.consume("\\]")}return this.consume(";"),t}}]),e}(),dasParser=exports.dasParser=function(t){function e(t,r){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.das=t,n.dataset=r,n}return _inherits(e,simpleParser),_createClass(e,[{key:"parse",value:function(){for(this._target=this.dataset,this.consume("attributes"),this.consume("{");!this.peek("}");)this._attr_container();return this.consume("}"),this.dataset}},{key:"_attr_container",value:function(){if(atomicTypes.contains(this.peek(IDENTIFIER_REGEX+"+").toLowerCase())){if(this._attribute(this._target.attributes),"Grid"==this._target.type)for(var t in this._target.maps)if(this.dataset[t]){var e=this._target.maps[e];for(var r in e.attributes)this.dataset[e].attributes[r]=e.attributes[r]}}else this._container()}},{key:"_container",value:function(){var t=this.consume("[\\w-_\\./]+");if(this.consume("{"),t.indexOf(".")>-1){for(var e=t.split("."),r=this._target,n=0;n<e.length;n++)this._target=this._target[e[n]];for(;!this.peek("}");)this._attr_container();this.consume("}"),this._target=r}else if(structures.contains(this._target.type)&&this._target[t]){var s=this._target;for(this._target=s[t];!this.peek("}");)this._attr_container();this.consume("}"),this._target=s}else this._target.attributes[t]=this._metadata(),this.consume("}")}},{key:"_metadata",value:function(){for(var t={};!this.peek("}");)if(atomicTypes.contains(this.peek(IDENTIFIER_REGEX+"+").toLowerCase()))this._attribute(t);else{var e=this.consume(IDENTIFIER_REGEX+"+");this.consume("{"),t[e]=this._metadata(),this.consume("}")}return t}},{key:"_attribute",value:function(t){for(var e=this.consume(IDENTIFIER_REGEX+"+"),r=this.consume(IDENTIFIER_REGEX+"+"),n=[];!this.peek(";");){var s=this.consume('".*?[^\\\\]"|[^;,]+');if("string"==e.toLowerCase()||"url"==e.toLowerCase())s=pseudoSafeEval(s);else if("alias"==e.toLowerCase()){var i=void 0,a=void 0;s.match(/^\\./)?(a=s.substring(1).split("."),i=this.dataset):(a=s.split("."),i=this._target);for(var o=0;o<a.length;o++){var u=a[o];s=i=i[u]?i[u]:i.array.name==u?i.array:i.maps[u]?i.maps[u]:i.attributes[u]}}else s="nan"==s.toLowerCase()?NaN:pseudoSafeEval(s);n.push(s),this.peek(",")&&this.consume(",")}this.consume(";"),1==n.length&&(n=n[0]),t[r]=n}}]),e}()},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DapClient=void 0;var n,s=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),i=r(2),a=r(1),o=(n=r(0))&&n.__esModule?n:{default:n};e.DapClient=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.IE_HACK=e,(0,o.default)(this.IE_HACK)}return s(t,[{key:"proxyUrl",value:function(t,e,r,n){var s=void 0;if(window.XMLHttpRequest?s=new XMLHttpRequest:window.ActiveXObject&&(s=new window.ActiveXObject("Microsoft.XMLHTTP")),s.open("GET",t,!0),s.overrideMimeType?s.overrideMimeType("text/plain; charset=x-user-defined"):s.setRequestHeader("Accept-Charset","x-user-defined"),n)for(var i in n)s.setRequestHeader(i,n[i]);s.onreadystatechange=function(){4==s.readyState&&(r?this.IE_HACK?e(BinaryToArray(s.responseBody).toArray()):e((0,a.getBuffer)(s.responseText)):e(s.responseText))},s.send("")}},{key:"_applydata",value:function(t,e){var r=0;for(var n in e)e[n].type&&(e[n].data=t[r++],"Structure"==e[n].type&&this._applydata(e[n].data,e[n]))}},{key:"loadData",value:function(t,e,r){this.proxyUrl(t,function(t){for(var r="";!r.match(/\nData:\n$/);){var n=t.splice(0,1);if(0===n.length)throw new Error("Error reading data, are you sur this is a .dods request ?");r+=String.fromCharCode(n)}r=r.substr(0,r.length-7);var s=new i.ddsParser(r).parse(),o=new a.dapUnpacker(t,s).getValue();this._applydata(o,s),e(s)},!0,r)}},{key:"loadDataset",value:function(t,e,r){this.proxyUrl(t+".dds",function(n){var s=new i.ddsParser(n).parse();this.proxyUrl(t+".das",function(t){s=new i.dasParser(t,s).parse(),e(s)},!1,r)},!1,r)}}]),t}()}])});
//# sourceMappingURL=jsdap.js.map